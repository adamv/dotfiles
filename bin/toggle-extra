#!/bin/bash
#/ Usage: toggle-extra (menu-extra) [on|off]
#/
#/ Examples:
#/  toggle-extra vpn
#/    Toggles display of the VPN extra
#/
#/  toggle-extra bluetooth off
#/    Forces off bluetooth extra


usage() {
    grep '^#/' <"$0" | cut -c4-
    exit 0
}


if [[ $# -lt 1 ]]; then
  usage
fi

which_extra=$1;shift
mode="toggle"

if [[ $# -ge 1 ]]; then
  mode=$1;shift
fi


PREFS_FILE=~/Library/Preferences/com.apple.systemuiserver.plist

extra_index=$(plutil -convert xml1 -o - $PREFS_FILE | ./extra-index $which_extra)

if [[ $extra_index == "-1" ]]; then
  [[ $mode == "on" || $mode == "toggle" ]] || exit 0

  # launch
  app="/System/Library/CoreServices/Menu Extras/$which_extra.menu"

  if [[ -e "$app" ]]; then
    open "$app"
  else
    echo "Extra not found"
    exit 1
  fi
else
  [[ $mode == "off" || $mode == "toggle" ]] || exit 0

  # kill
  /usr/libexec/PlistBuddy -c "Delete :menuExtras:$extra_index" $PREFS_FILE
  killall SystemUIServer -HUP
fi
